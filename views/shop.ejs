<%- include('./partials/header') %>

<style>
.out-of-stock {
    opacity: 0.6;
    filter: grayscale(100%);
}

.out-of-stock .product-info-panel {
    background-color: #f5f5f5 !important;
    color: #999 !important;
}
</style>

    <% if(success && success.length>0){ %>
        <div class="fixed top-5 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg bg-green-500 shadow-lg animate-fade-in">
            <span class="inline-block text-white font-medium">
                <%= Array.isArray(success) ? success[0] : success %>
            </span>
        </div>
        <% } %>
            <div class="container mx-auto px-4 md:px-8 py-8 flex-grow">
                <% if(typeof searchTerm !== 'undefined' && searchTerm) { %>
                    <h1 class="text-3xl font-bold mb-8 text-gray-800">Search Results for "<%= searchTerm %>"</h1>
                <% } else { %>
                    <h1 class="text-3xl font-bold mb-8 text-gray-800">Our Products</h1>
                <% } %>
                <div class="md:flex gap-8">
                    <div class="w-full md:w-1/4 bg-white rounded-lg shadow-md p-6 h-fit mb-6 md:mb-0">
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-3 text-gray-800">Sort By</h3>
                            <form action="/shop" method="GET">
                                <!-- Preserve existing filters -->
                                <% if(typeof category !== 'undefined' && category) { %>
                                    <input type="hidden" name="category" value="<%= category %>">
                                <% } %>
                                <% if(typeof filter !== 'undefined' && filter) { %>
                                    <input type="hidden" name="filter" value="<%= filter %>">
                                <% } %>
                                <select
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    name="sortby" id="sortby-select">
                                    <option value="popular" <%= (typeof sortby !== 'undefined' && sortby === 'popular') ? 'selected' : '' %>>Popular</option>
                                    <option value="newest" <%= (typeof sortby !== 'undefined' && sortby === 'newest') ? 'selected' : '' %>>Newest</option>
                                    <option value="price-low" <%= (typeof sortby !== 'undefined' && sortby === 'price-low') ? 'selected' : '' %>>Price: Low to High</option>
                                    <option value="price-high" <%= (typeof sortby !== 'undefined' && sortby === 'price-high') ? 'selected' : '' %>>Price: High to Low</option>
                                </select>
                            </form>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-3 text-gray-800">Categories</h3>
                            <div class="flex flex-col gap-2">
                                <a class="px-3 py-2 rounded-lg hover:bg-rose-50 hover:text-rose-600 transition-colors flex items-center gap-2"
                                    href="/shop?category=new">New Collection
                                    <i class="ri-arrow-right-s-line text-sm"></i>
                                </a>
                                <a class="px-3 py-2 rounded-lg hover:bg-rose-50 hover:text-rose-600 transition-colors flex items-center gap-2"
                                    href="/shop">All Products
                                    <i class="ri-arrow-right-s-line text-sm"></i>
                                </a>
                                <a class="px-3 py-2 rounded-lg hover:bg-rose-50 hover:text-rose-600 transition-colors flex items-center gap-2"
                                    href="/shop?category=discounted">Discounted Products
                                    <i class="ri-arrow-right-s-line text-sm"></i>
                                </a>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-gray-800">Filters</h3>
                            <div class="flex flex-col gap-2">
                                <a class="px-3 py-2 rounded-lg hover:bg-rose-50 hover:text-rose-600 transition-colors flex items-center gap-2"
                                    href="/shop?filter=available">In Stock
                                    <i class="ri-check-line text-sm"></i>
                                </a>
                                <a class="px-3 py-2 rounded-lg hover:bg-rose-50 hover:text-rose-600 transition-colors flex items-center gap-2"
                                    href="/shop?filter=discount">On Sale
                                    <i class="ri-percent-line text-sm"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="w-full md:w-3/4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <% products.forEach(function(product, index){ %>
                                <div class="w-full">
                                    <div class="product-card-item rounded-lg shadow-md transition-all duration-300 overflow-hidden transform hover:-translate-y-1 product-card group <%= (!product.stock || product.stock <= 0) ? 'out-of-stock' : '' %>">

                                        <!-- Product Image -->
                                        <a href="/product/<%= product._id %>" class="block">
                                            <div class="w-full h-52 flex items-center justify-center rounded-t-lg overflow-hidden"
                                                style="background-color:<%= product.bgcolor || '#ffffff' %>;">
                                                <% if(product.image){ %>
                                                    <img class="h-[12rem] w-auto object-contain"
                                                        src="<%= product.image %>" alt="<%= product.name %>">
                                                    <% } else { %>
                                                        <div class="text-gray-400">No Image</div>
                                                        <% } %>
                                            </div>
                                        </a>

                                        <!-- Product Info Panel -->
                                        <div class="product-info-panel flex justify-between items-center px-4 py-4 rounded-b-lg" style="background-color: <%= product.panelcolor || '#f3f4f6' %>; color: <%= product.textcolor || '#000000' %>;">
                                            <a href="/product/<%= product._id %>" class="flex-1">
                                                <h3
                                                    class="font-semibold text-lg hover:text-purple-600 transition-colors">
                                                    <%= product.name %>
                                                </h3>

                                                <div class="flex items-center gap-2">
                                                    <h4 class="text-xl font-bold">₹ <%= product.price %>
                                                    </h4>

                                                    <% if(product.discount && product.discount> 0){ %>
                                                        <span class="text-sm text-green-600 font-semibold">
                                                            Save ₹<%= product.discount %>
                                                        </span>
                                                        <% } %>
                                                </div>
                                            </a>

                                            <!-- Buttons -->
                                            <div class="flex gap-2 ml-4">
                                                <a class="w-8 h-8 flex items-center justify-center rounded-full bg-white hover:bg-purple-500 hover:text-white transition-all duration-300 shadow-md transform hover:scale-110"
                                                    href="/product/<%= product._id %>"
                                                    onclick="event.stopPropagation()">
                                                    <i class="ri-eye-line text-lg"></i>
                                                </a>

                                                <% if(product.stock && product.stock > 0) { %>
                                                <a class="w-8 h-8 flex items-center justify-center rounded-full bg-white hover:bg-purple-500 hover:text-white transition-all duration-300 shadow-md transform hover:scale-110"
                                                    href="/addtocart/<%= product._id %>"
                                                    onclick="event.stopPropagation()">
                                                    <i class="ri-add-line text-lg"></i>
                                                </a>
                                                <% } else { %>
                                                <button class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-400 text-white cursor-not-allowed shadow-md opacity-50"
                                                    disabled>
                                                    <i class="ri-close-circle-line text-lg"></i>
                                                </button>
                                                <% } %>
                                                
                                                <% if(locals.loggedin) { %>
                                                <button class="w-8 h-8 flex items-center justify-center rounded-full bg-white hover:bg-red-500 hover:text-white transition-all duration-300 shadow-md transform hover:scale-110 wishlist-btn"
                                                    data-product-id="<%= product._id %>"
                                                    onclick="event.stopPropagation()">
                                                    <i class="ri-heart-line text-lg"></i>
                                                </button>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <% }) %>
                        </div>
                    </div>
                </div>
            </div>
            <%- include('./partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sorting functionality
    const sortSelect = document.getElementById('sortby-select');
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            this.form.submit();
        });
    }
    
    // Wishlist functionality
    const wishlistButtons = document.querySelectorAll('.wishlist-btn');
    
    wishlistButtons.forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            const productId = this.getAttribute('data-product-id');
            
            try {
                const response = await fetch(`/add-to-wishlist/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if(result.success) {
                    // Toggle heart icon
                    const icon = this.querySelector('i');
                    if(icon.classList.contains('ri-heart-line')) {
                        icon.classList.remove('ri-heart-line');
                        icon.classList.add('ri-heart-fill');
                        this.classList.add('bg-red-500', 'text-white');
                    } else {
                        icon.classList.remove('ri-heart-fill');
                        icon.classList.add('ri-heart-line');
                        this.classList.remove('bg-red-500', 'text-white');
                    }
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'fixed top-20 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg bg-green-500 shadow-lg animate-fade-in';
                    successDiv.innerHTML = '<span class="inline-block text-white font-medium">' + result.message + '</span>';
                    document.body.appendChild(successDiv);
                    
                    // Auto-remove message after 3 seconds
                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error adding to wishlist:', error);
                alert('An error occurred while adding to wishlist');
            }
        });
    });
});
</script>