<%- include('./partials/header') %>

    <div class="container mx-auto px-4 md:px-8 py-8 flex-grow" style="background-color: #FAFAFA;">
        <h1 class="text-3xl font-bold mb-8" style="color: #1E1E1E;">Checkout</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Razorpay Payment Section -->
            <div class="lg:col-span-2">
                <div class="rounded-lg shadow-md p-6 mb-6"
                    style="background-color: #FAFAFA; border: 1px solid #E5E5E5;">

                    <h2 class="text-2xl font-bold mb-6" style="color: #1E1E1E;">
                        Secure Payment
                    </h2>

                    <p class="mb-6 text-gray-600">
                        Click below to pay securely using Razorpay.
                    </p>

                    <button id="pay-btn"
                        class="w-full px-6 py-3 rounded-lg text-white font-semibold transition-all duration-300"
                        style="background-color: #B76E79;">
                        Pay ₹ <%= finalBill.toFixed(2) %>
                    </button>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="rounded-lg shadow-md p-6 sticky top-20"
                    style="background-color: #FAFAFA; border: 1px solid #E5E5E5;">
                    <h3 class="text-2xl font-bold mb-6" style="color: #1E1E1E;">
                        Order Summary
                    </h3>

                    <% let subtotal=0; user.cart.forEach(item=> {
                        subtotal += Number(item.price || 0);
                        });

                        let platformFee = 20;

                        let couponDiscountValue = typeof couponDiscount !== "undefined"
                        ? Number(couponDiscount)
                        : 0; %>

                        <div class="space-y-4 mb-6">
                            <% user.cart.forEach(function(item){ %>
                                <div class="flex justify-between items-center pb-4 border-b"
                                    style="border-color: #E5E5E5;">
                                    <div>
                                        <p class="font-medium" style="color: #1E1E1E;">
                                            <%= item.name %>
                                        </p>
                                        <p class="text-sm text-gray-500">
                                            ₹ <%= item.price %>
                                        </p>
                                    </div>
                                </div>
                                <% }) %>

                                    <div class="flex justify-between pt-4">
                                        <span class="text-gray-600">Subtotal</span>
                                        <span>₹ <%= subtotal.toFixed(2) %></span>
                                    </div>

                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Platform Fee</span>
                                        <span>₹ 20.00</span>
                                    </div>

                                    <% if(couponDiscountValue> 0){ %>
                                        <div class="flex justify-between text-green-600">
                                            <span>Coupon Discount</span>
                                            <span>- ₹ <%= couponDiscountValue.toFixed(2) %></span>
                                        </div>
                                        <% } %>

                                            <div class="border-t pt-4">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-lg font-semibold">
                                                        Total
                                                    </span>
                                                    <span class="text-2xl font-bold" style="color:#B76E79;">
                                                        ₹ <%= finalBill.toFixed(2) %>
                                                    </span>
                                                </div>
                                            </div>

                        </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Razorpay Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        document.getElementById("pay-btn").onclick = async function () {

            const response = await fetch("/payment/create-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount: <%= finalBill %> })
        });

        const order = await response.json();

        var options = {
            key: "<%= process.env.RAZORPAY_KEY_ID %>",
            amount: order.amount,
            currency: "INR",
            name: "Urban Elite",
            description: "Order Payment",
            order_id: order.id,
            handler: async function (response) {

                const verifyRes = await fetch("/payment/verify-payment", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(response)
                });

                const verifyData = await verifyRes.json();

                if (verifyData.success) {
                    window.location.href = `/order/${verifyData.orderId}`;
                } else {
                    alert("Payment verification failed");
                }
            },
            theme: {
                color: "#B76E79"
            }
        };

        var rzp = new Razorpay(options);
        rzp.open();
};
    </script>

    <%- include('./partials/footer') %>